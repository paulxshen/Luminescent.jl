{"version":3,"kind":"Notebook","sha256":"b5e93adb0b3934fab7a98dabcf7f15d01822e5dc5e5d9f40b1411c193d353da4","slug":"test-stub","location":"/test_stub.ipynb","dependencies":[],"frontmatter":{"title":"RF microstrip: quarter wave stub filter","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Python 3","language":"python"},"numbering":{"title":{"offset":2}},"exports":[{"format":"ipynb","filename":"test_stub.ipynb","url":"/build/test_stub-aa53768a3e128b2d58c4abbd03abed4c.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Overview","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"G9oS89lkYm"}],"identifier":"overview","label":"Overview","html_id":"overview","implicit":true,"key":"JnAZhmg2Gy"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"We simulate a quarter wave stub bandstop filter in RF microstrip with nominal 5GHz notch.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"U9ModlCdJB"}],"key":"IRK3QKOuad"}],"key":"rXnvtKM8zE"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Geometry","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"pSYR3vDlM9"}],"identifier":"geometry","label":"Geometry","html_id":"geometry","implicit":true,"key":"PLbsRFMrPE"}],"key":"PEjLXUXhlp"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import luminescent as lumi\nfrom gdsfactory.technology import LogicalLayer, LayerLevel, LayerStack\nimport gdsfactory as gf\nimport matplotlib.pyplot as plt\nimport numpy as np\nimport os\n\n# simulation folder \nstudy='microstrip_stub_filter'\npath = os.path.join('studies', study)\n\n# length and frequency units are arbitrary but must be consistent. here we use mm and GHz\nfrequency = 5  # characteristic frequency in GHz\nfrequencies = np.linspace(3, 7, 81).tolist()\nwl1f = 300  # vacuum wavelength at 1 unit of frequency, all in your units\nwavelength = wl1f / frequency  # characteristic wavelength\nbandwidth = max(frequencies) - min(frequencies)\n\n# microstrip\nw_line = 1.52  # mm\nth = 0.035  # mm\nd = 0.8  # mm\nc = 87.5 / 139  # relative signal speed, from microstrip calculator\n\nwl_sig = wl1f * c / frequency  # wavelength in the signal line\nl_stub = wl_sig / 4 # quarter-wave stub length\nl_feed = 1 * l_stub\nlateral_port_margin = height_port_margin = 2 * d\nmargin = zmargin = 1.25 * lateral_port_margin\nlx_mode = w_line + 2 * lateral_port_margin  # lateral size of mode region\nsource_port_margin = 1.5 * (w_line + 2 * lateral_port_margin)\n\n# layers\nFEED = 1, 0\nSTUB = 2, 0\nSUB = 10, 0\n\n# make geometry in gdsfadory\n# alternatively can import .gds into gdsfadory\nc = gf.Component()\nfeed = c << lumi.straight(length=l_feed, width=w_line, layer=FEED)\nstub = c << lumi.straight(length=l_stub, width=w_line, layer=STUB)\nstub.rotate(90)\nstub.movex(l_feed / 2)\next = c << lumi.straight(source_port_margin, width=w_line, layer=FEED)\next.connect(\"o2\", feed.ports[\"o1\"])\n\nfor i in (1, 2):\n    c.add_port(f\"o{i}\", port=feed.ports[f\"o{i}\"])\n\nc << gf.components.bbox(component=c, layer=SUB, top=margin, bottom=margin)\nc.plot()","key":"EeT8SMTISW"},{"type":"outputs","id":"r-WI4_IbG_REpE1GRN7tb","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"running luminescent python frontenda\n"},"children":[],"key":"e45nh1S8JA"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"7114bf13a945cd34d8e0cc546072a95a","path":"/build/7114bf13a945cd34d8e0cc546072a95a.png"},"text/plain":{"content":"<Figure size 800x600 with 1 Axes>","content_type":"text/plain"}}},"children":[],"key":"sDjoed4NLm"}],"key":"VFAE0pl5FE"}],"key":"VFZlmWcpEG"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Solve","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"fd3FZpYxS1"}],"identifier":"solve","label":"Solve","html_id":"solve","implicit":true,"key":"YFud258Uff"}],"key":"tUTs9x6GWo"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# adaptive meshing\nnres = 16\ndx0 = wavelength / nres\n\nlayer_stack = LayerStack(\n    layers={\n        \"feed\": LayerLevel(\n            layer=LogicalLayer(layer=FEED),\n            zmin=0,\n            thickness=th,\n            material=\"PEC\",\n            mesh_order=10,\n        ),\n        \"stub\": LayerLevel(\n            layer=LogicalLayer(layer=STUB),\n            zmin=0,\n            thickness=th,\n            material=\"PEC\",\n            mesh_order=20,\n        ),\n        \"core\": LayerLevel(\n            layer=LogicalLayer(layer=SUB),\n            zmin=-d,\n            thickness=d,\n            material=\"sub\",\n            mesh_order=30,\n        ),\n    }\n)\n\n# materials\neps_sub = 4.3\nn_sub = np.sqrt(eps_sub)\n\ndx = w_line / 4  # 4 mesh points across the strip\nn_PEC = dx0 / (dx)  # mesh density relative to vacuum\n\nmaterial_library = {\n    \"sub\": lumi.Material(epsilon=eps_sub),\n    \"PEC\": lumi.PECMaterial(mesh_density=n_PEC),\n}\nmaterial_library[\"background\"] = lumi.Material(epsilon=1.0)\n\n_dx=dx \n_dy=th\nmodes = [\n    lumi.Mode(\n        ports=[\"o1\", \"o2\"],\n        frequencies=[frequency],\n        metallic_boundaries=[\"y-\", \"feed\"],\n        nmodes=1,\n        start=[-lx_mode/2, -d], # local xy frame, local y=0 at global zmin of port layer\n        stop=[lx_mode/2, th + height_port_margin],\n        voltage_line=[(0, -d), (0, 0)], # optional\n        current_loop=[\n            (-w_line / 2 - _dx,  - _dy),\n            (-w_line / 2 - _dx,  th + _dy),\n            (w_line / 2 + _dx,  th + _dy),\n            (w_line / 2 + _dx,  - _dy),\n        ], # optional\n    )\n]\n\nsources = [\n    lumi.Source(\n        \"o1\", frequency=frequency, duration=0.5, source_port_margin=source_port_margin\n    ) # modulated Gaussian pulse\n]\n\nviews=[\n        lumi.View(\"Ez\", x=-source_port_margin, y=0, z=-d / 2),\n        lumi.View(\"Hz\", z=th / 2),\n    ]\n \n# Luminescent community cluster client\nemail=____# replace with your registered email\nclient=lumi.Client(email,cluster='luminescent_community_cluster')\n\nlumi.make(\n    path=path,\n    component=c,\n    frequency=frequency, # characteristic frequency\n    frequencies=frequencies,\n    wl1f=wl1f,\n    sources=sources,\n    modes=modes,\n    # bounds\n    boundaries=[\"PML\", \"PML\", [\"PEC\", \"PML\"]],\n    zmin=-d,\n    zmax=th + zmargin,\n    #\n    material_library=material_library,\n    layer_stack=layer_stack,\n    # performance\n    nres=nres,\n    relative_courant=0.9,  # relative courant number between 0 and 1\n    relative_pml_depths=[1, 0.3, 0.3],\n    energy_decay_threshold=0.01,  # field decay threshold for stopping simulation\n    saveat=1,  # save frame for plotting every _ periods\n    # visualization\n    views=views,\n    # \n    client=client,\n)","key":"eWqyE4iDBV"},{"type":"outputs","id":"j0QmuGJAqDkZ4JHCrr00B","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"saving mode plots to /home/weihu/lumi/luminescent/studies/microstrip_stub_filter/modes/1\nshowing modes for first wavelength \nsolving modes with PEC boundaries\nSolving port modes with FEM...\n"},"children":[],"key":"Hry5YUdMnl"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"0add8a15de72c121412c123c763a47a9","path":"/build/0add8a15de72c121412c123c763a47a9.png"},"text/plain":{"content":"<Figure size 640x480 with 6 Axes>","content_type":"text/plain"}}},"children":[],"key":"cH5h5XJ4bs"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"4adc9eb730b7ccb0cbb6c1bda3fc40c2","path":"/build/4adc9eb730b7ccb0cbb6c1bda3fc40c2.png"},"text/plain":{"content":"<Figure size 640x480 with 6 Axes>","content_type":"text/plain"}}},"children":[],"key":"AyQJWJFKQ6"},{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"/home/weihu/.local/lib/python3.12/site-packages/skfem/assembly/form/linear_form.py:44: ComplexWarning: Casting complex values to real discards the imaginary part\n  data[ixs] = self._kernel(vbasis.basis[i], w, dx)\n/home/weihu/lumi/luminescent/luminescent/utils.py:655: ComplexWarning: Casting complex values to real discards the imaginary part\n  E = np.array(\n/home/weihu/lumi/luminescent/luminescent/utils.py:668: ComplexWarning: Casting complex values to real discards the imaginary part\n  H = np.array(\n"},"children":[],"key":"tYmIsP8V5K"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"using simulation folder /home/weihu/lumi/luminescent/studies/microstrip_stub_filter\n0.19\nLoading mesh from: /home/weihu/lumi/luminescent/studies/microstrip_stub_filter/geometry/1____PEC____feed____unnamed11.obj\n0.19\nLoading mesh from: /home/weihu/lumi/luminescent/studies/microstrip_stub_filter/geometry/2____PEC____feed____unnamed21.obj\n0.19\nLoading mesh from: /home/weihu/lumi/luminescent/studies/microstrip_stub_filter/geometry/3____PEC____stub____unnamed31.obj\n0.9042052915695228\nLoading mesh from: /home/weihu/lumi/luminescent/studies/microstrip_stub_filter/geometry/4____sub____core____unnamed41.obj\n"},"children":[],"key":"ulJIYym3NX"}],"key":"RCxLVkVxCv"}],"key":"mSArGs4h8R"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"lumi.solve(path)","key":"kmwuaPdCUm"},{"type":"outputs","id":"cM4gqQ_dhKyJt3aVqWUw6","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"loading problem from /home/weihu/luminescent_community_cluster/paul@luminescentai.com/microstrip_stub_filter\nStatus Code: 200\nauthentication successful\nmax run time per job is 15 minutes\njob queued. aborting this python client also aborts the job in the cluster jobs ...\n\n========================================\nloading simulation folder /home/weihu/luminescent_community_cluster/paul@luminescentai.com/microstrip_stub_filter ...\n\nCPU:\n\tthreads: 48\n\nGPU 0: NVIDIA RTX PRO 6000 Blackwell Server Edition\n\tCUDA Compute Capability: 12.0.0\n\tVRAM: 94.97076416015625 GB\n\n========================================\nsetting up simulation...\n\nmeshing geometry\nmaking sources...\nmaking monitors...\nmaking designs...\n\n========================================\nsimulation config\n\nbackend: GPU\nfloat: Float32\n\noriginal size: (46, 36, 17)\npadded size: (91, 50, 24)\ncell count: 109,200\n\nrelative Courant number: 0.9\nstep size: 1936.0 steps/period\nsource duration: 0.50 periods\nmax time: 1,000.50 periods    \nenergy decay threshold: 0.01\n\n========================================\nrunning simulation...\n\naccumulating dft fields...\nperiod 0.00, Inf seconds/period\nperiod 0.25, 7.29 seconds/period\nperiod 1.00, energy 0.3643, 4.14 seconds/period\nperiod 2.00, energy 0.0529, 3.41 seconds/period\nperiod 3.00, energy 0.0121, 3.79 seconds/period\nperiod 3.61, energy 0.0098, 4.48 seconds/period\nstop on field decay\n\nsimulation completed.\n\n========================================\ngenerating movie...\n\n\nmovie frames completed.\nsimulation completed successfully!\n"},"children":[],"key":"L8aBnbQe6o"}],"key":"FpOg2QhoFA"}],"key":"G8k5MMCHpx"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Visualize","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xS5NE4nxDw"}],"identifier":"visualize","label":"Visualize","html_id":"visualize","implicit":true,"key":"Bz2qImpjAJ"}],"key":"tXhVQ7JtZS"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"lumi.movie(path)","key":"s7uuoRTMEc"},{"type":"outputs","id":"Z3hQdtWUAsaWXwpxXJTEa","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Video generated successfully at /home/weihu/luminescent_community_cluster/paul@luminescentai.com/microstrip_stub_filter/simulation.gif!\n"},"children":[],"key":"ll90g88qbp"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/gif":{"content_type":"image/gif","hash":"be47e9c3021af5fc83138d3f8c00cf7b","path":"/build/be47e9c3021af5fc83138d3f8c00cf7b.gif"},"text/plain":{"content":"<IPython.core.display.Image object>","content_type":"text/plain"}}},"children":[],"key":"POwifIIc2X"}],"key":"YP8CSJqVpp"}],"key":"rC8joTYn0m"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Analysis","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"SzrwJc5Pma"}],"identifier":"analysis","label":"Analysis","html_id":"analysis","implicit":true,"key":"tB4758CEJ1"}],"key":"c8TAD8JgqH"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"sol = lumi.load(path)\nx = frequencies\ny = lumi.query(sol, \"To2,o1\") # convenience function for T-parameters using modal decomposition\n\n# S-parameters can also be computed explicitly from complex valued modal or voltage waves:\n# y = np.abs2(sol[\"waves\"][\"o2@0+\"] / sol[\"waves\"][\"o1@0-\"]) # explicit T21 using forward/backward modal amplitudes\n# y = np.abs2(sol[\"waves\"][\"o2+\"] / sol[\"waves\"][\"o1-\"]) # using forward/backward voltage waves\n\ny = [10 * np.log10(v) for v in y]\nplt.plot(x, y)\nplt.xlabel(\"f [GHz]\")\nplt.ylabel(\"S21 [dB]\")\nplt.show()","key":"D1eX2yLFF4"},{"type":"outputs","id":"gOPL_k7wilSIXrNqKkKpJ","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"loading solution from /home/weihu/luminescent_community_cluster/paul@luminescentai.com/microstrip_stub_filter\nmay take a minute if simulation folder is remotely mounted\n"},"children":[],"key":"YnSZsUCfth"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"b2c6ced83b66a3f6982eb3f788cc34b6","path":"/build/b2c6ced83b66a3f6982eb3f788cc34b6.png"},"text/plain":{"content":"<Figure size 640x480 with 1 Axes>","content_type":"text/plain"}}},"children":[],"key":"gx4bWnKeh7"}],"key":"nPTVZ0SFcl"}],"key":"H86gBvvDvT"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"y=377*sol['Z']['o1']\nplt.plot(x,np.real(y),label=\"Real\",color='orange')\nplt.plot(x,np.imag(y),label=\"Imaginary\",color='blue')\nplt.xlabel(\"f [GHz]\")\nplt.ylabel('complex line impedance [Ohms]')\nplt.legend()\nplt.show()","key":"s8iqnwm1Ze"},{"type":"outputs","id":"72p4CQu-VIgO2zmUdO9Go","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"65c36634582c00dedf7cd74d5b10e2fc","path":"/build/65c36634582c00dedf7cd74d5b10e2fc.png"},"text/plain":{"content":"<Figure size 640x480 with 1 Axes>","content_type":"text/plain"}}},"children":[],"key":"vJ3RgJK6sB"}],"key":"Xn6fKa3WNr"}],"key":"eWcd0urpn1"}],"key":"pN7mCxd3sv"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Metasurface: microwave frequency selective surface (FSS)","url":"/test-fss","group":"Simulation tutorials"},"next":{"title":"Photonic PDK","url":"/pdk","group":"Lumi photonic PDK"}}},"domain":"http://localhost:3000"}