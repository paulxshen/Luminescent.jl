{"version":3,"kind":"Notebook","sha256":"73c8724adc6125a6fd08f3b9e1baf51418d4b86d266b49c45973174616be7cad","slug":"opt-pvgc","location":"/opt_PVGC.ipynb","dependencies":[],"frontmatter":{"title":"Perfectly Vertical Grating Coupler (PVGC) Inverse Design","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Python 3","language":"python"},"numbering":{"title":{"offset":2}},"exports":[{"format":"ipynb","filename":"opt_PVGC.ipynb","url":"/build/opt_PVGC-f65b15cd9908055855f76138384b825b.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Geometry","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TEFccNrtfg"}],"identifier":"geometry","label":"Geometry","html_id":"geometry","implicit":true,"key":"vxIxfNrLMj"}],"key":"qtsi6hqEI9"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\nimport numpy as np\nimport luminescent as lumi\nimport gdsfactory as gf\nfrom gdsfactory.technology import LogicalLayer, LayerLevel, LayerStack\nimport matplotlib.pyplot as plt\n\nwideband = False\nbidirectional = False\n\nif wideband and bidirectional:\n    study=\"wbPVGC\" # wideband bidirectional\nelif bidirectional:\n    study=\"bPVGC\" # bidirectional\nelse:\n    study=\"PVGC\"\n\n# folder for saving config and results\npath = os.path.join(\"studies\", study)\n\nwavelength=1.55\nif wideband:\n    bandwidth=.07\nelse:\n    bandwidth = 0.005\nwavelengths = np.linspace(wavelength-bandwidth/2, wavelength+bandwidth/2, 5)\n\neps_Si = 12.25\neps_SiO2 = 2.1708\nn_Si = np.sqrt(eps_Si)\nn_SiO2 = np.sqrt(eps_SiO2)\nλ_Si=wavelength/n_Si\nλ_SiO2=wavelength/n_SiO2\n\nmaterial_wg='Si'\nmaterial_clad = \"SiO2\"\n\nmaterial_library = {\n    \"Si\": lumi.Material(eps_Si),\n    \"SiO2\": lumi.Material(eps_SiO2),\n}\nmaterial_library[\"background\"] = material_library[\"SiO2\"]  # set background material\nmaterial_library[\"design\"] = lumi.PlaceholderMaterial(n_Si)\n\nw = 10.4  # gaussian beam waist\nr= w / 2  # source gaussian radius\nR=1.5*r\n\nif bidirectional:\n    w_design =1*R  # of design region\n    l_design =1.5 *R # of design region\nelse:\n    w_design =1*R  # of design region\n    l_design =2*R # of design region\n\nw_wg = 0.5\nl_wg = 2 * w_wg\nh_wg = 0.22\nd_etch = 0.07\nh_slab = h_wg - d_etch\n\n# margins\nlateral_port_margin = height_port_margin = 1*h_wg\nmargin = 1.25 * lateral_port_margin\nzmargin = 1.25 * height_port_margin\n\nλ_Si=wavelength/n_Si\nλ_SiO2=wavelength/n_SiO2\n\nnres = 4  # number of grid points per wavelength in material (not vacuum)\n\ndz=λ_SiO2/ nres\nsource_port_margin = 2*dz\n\ngap1=zmargin\ngap2=1/4*λ_SiO2\nz_port = h_wg+gap1\nzmin=-gap2\nzmax=z_port+source_port_margin\n\nWG = 1, 0\nBBOX = 10, 0\nDESIGN = 500, 0\n\n# makes gdsfadory component to be optimized. has rectangular design region with port stubs. ports numbered clockwise from bottom left.\nc = gf.Component()\ntaper=.1\ndesign = c << lumi.mimo(\n    l_design,\n    w_design,\n    east=[w_design-w_wg/4],\n    w_wg=w_wg/2,\n    l_wg=l_wg,\n    layer_wg=WG,\n    layer_design=DESIGN,\n    taper=[(0, taper/2)],\n    init=1,\n)\n\nsource_port=f'o1'\nc.add_port(f'o2', port=design.ports[f'o1'])\n\nif bidirectional:\n    c << gf.components.bbox(component=c, layer=BBOX, top=margin)\nelse:\n    design.movex(-R)\n    c << gf.components.bbox(component=c, layer=BBOX, top=margin,left=margin,)\nc.plot()","key":"rASFyQecIl"},{"type":"outputs","id":"gdieSYw-AVA2w2envsfAx","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"running luminescent python frontenda\n"},"children":[],"key":"sioBoDa1Ry"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"7608b1102bc2ca301b3eb96e5099b10f","path":"/build/7608b1102bc2ca301b3eb96e5099b10f.png"},"text/plain":{"content":"<Figure size 800x600 with 1 Axes>","content_type":"text/plain"}}},"children":[],"key":"YlVRinDEL6"}],"key":"JIl4ZcofCm"}],"key":"ClA4CsxVcS"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Solve","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"IJW6Q8BYpf"}],"identifier":"solve","label":"Solve","html_id":"solve","implicit":true,"key":"Wup4VI3lzl"}],"key":"ye6sKihpvS"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# layer stack. lower mesh order layers override higher mesh order layers. for 2.5D problems as is here, the mesher will slice thru middle of 'core' layer\nlayers = {\n    \"wg\": LayerLevel(\n        layer=LogicalLayer(layer=WG),\n        zmin=0,\n        thickness=h_wg,\n        material='Si',\n        mesh_order=100,\n    ),\n    \"design\": LayerLevel(\n        layer=LogicalLayer(layer=DESIGN),\n        zmin=h_slab,\n        thickness= d_etch,\n        material=\"design\",\n        mesh_order=1,\n    ),\n}\nlayer_stack = LayerStack(layers=layers)\n\n_dx = λ_SiO2 / nres\nnr = round(R/_dx)\n_dx=R/nr\n\nif bidirectional:\n    x =y= np.linspace(_dx/2,R-_dx/2, nr)\nelse:\n    x = np.linspace(-R+_dx/2,R-_dx/2,2*nr)\n    y = np.linspace(_dx/2,R-_dx/2, nr)\nX, Y = np.meshgrid(x, y, indexing='ij')\ng = np.exp(-(X**2 + Y**2) / (2 * (w/2) ** 2))\n\nwg_mode=lumi.Mode(\n        ports=['o2'],\n        start=[-w_wg/4, -height_port_margin],\n        stop=[w_wg / 4+lateral_port_margin, h_wg + height_port_margin],\n        boundaries=[('PEC','PML'),'PML']\n    )\nif bidirectional:\n    source_mode=lumi.Mode(\n        ports=[source_port],\n         fields={\n            \"Ey\": g,\n            \"Hx\": -g * n_SiO2,\n        },\n        start=[0, 0],\n        stop=[R,R],\n        boundaries=[('PMC','PML'),('PEC','PML')]\n    )\nelse:\n    source_mode=lumi.Mode(\n        ports=[source_port],\n        fields={\n            \"Ey\": g,\n            \"Hx\": -g * n_SiO2,\n        },\n        start=[-R, 0],\n        stop=[R,R],\n        boundaries=['PML',('PEC','PML')]\n    )\nmodes = [wg_mode, source_mode]\n\n\n# additional ports not attached to gdsfactory component\nports = [\n    lumi.PlanePort(\n        name=source_port,\n        origin=[0, 0, z_port],\n        frame=[[1, 0, 0], [0, 1, 0], [0, 0, 1]],\n    )\n]\n\nsources = [\n    lumi.Source(\n        source_port,\n        wavelength=wavelength,\n        bandwidth=wavelength / 5,\n        source_port_margin=source_port_margin,\n    )\n]\n\ntargets =        [\n            lumi.Target(\n                key=f\"To2@0,{source_port}@0\",\n                target=1,\n                weight=1 / len(wavelengths),\n                wavelength=wl,\n                func=\"relu-\",\n            )\n            for wl in wavelengths        ]\n\ntmax = 1.3 *(\n    ( 6*(h_wg*n_Si+gap2*n_SiO2)+(source_port_margin+gap1)*n_SiO2) \n    + (l_wg +l_design + w_design+R)* n_Si\n) / wavelength\n\nlmin_design = 0.065\ndesigns = [\n    lumi.Design(\n        \"design\",\n        layer=DESIGN,\n        lmin=lmin_design,\n        fill_material='Si',\n        void_material='SiO2',\n        uniform_along=\"z\",\n    ),\n]\n\noptimizer = lumi.Optimizer(\n    stoploss=0.1,\n    # lowloss=0.4,\n    iters=30,  # max iters\n    momentum=0.8,\n    # contrast=1.0,\n)\n\nboundaries = ['PML', ['PEC',\"PML\"], [\"PEC\", \"PML\"]]\nrelative_pml_depths = [.7, 0.3, 0.7]  # relative PML thicknesses in x, y, z\n\nlabels={\n    # 'o1':'λ = 1311nm',\n}\n\nif bidirectional:\n    mirrors=['x-','y-']\nelse:\n    mirrors=['y-']\nviews = [\n    lumi.View(\"Ey\",y=0, z=d_etch / 2 + h_slab,mirrors=mirrors,show_box=False,material_color_intensity=5),\n]\n\nrelative_courant = 0.95\nsaveat = 25  # save frame every `saveat` periods for movie\n\nlumi.make(\n    #\n    path=path,  # path to make problem folder\n    component=c,\n    wavelength=wavelength,\n    wavelengths=wavelengths,\n    ports=ports,\n    modes=modes,\n    sources=sources,\n    boundaries=boundaries,\n    #\n    material_library=material_library,\n    layer_stack=layer_stack,\n    #\n    zmin=zmin,  # zmin of simulation region\n    zmax=zmax,  # zmax of simulation region\n    #\n    nres=nres,\n    tmax=tmax,  # total simulation time in periods\n    relative_pml_depths=relative_pml_depths,\n    relative_courant=relative_courant,\n    saveat=saveat,\n    #\n    views=views,\n    # inverse design parameters\n    # load_saved_designs=True,\n    designs=designs,\n    targets=targets,\n    optimizer=optimizer,\n)\nraise SystemExit","key":"ykRXKnrKCA"},{"type":"outputs","id":"VQt60BiQH8oWsmMM4Akef","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"saving mode plots to /home/weihu/lumi/luminescent/studies/PVGC/modes/1\n"},"children":[],"key":"VSyDPqIbAg"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"showing modes for first wavelength \nmode Boundary conditions: 000A\n/home/weihu/lumi/luminescent/studies/PVGC/modes/1/1.55 mode 0 (neff=0.424+0.000j)\n/home/weihu/lumi/luminescent/studies/PVGC/modes/1/1.55 mode 1 (neff=0.000+1.363j)\nsaving mode plots to /home/weihu/lumi/luminescent/studies/PVGC/modes/2\nusing simulation folder /home/weihu/lumi/luminescent/studies/PVGC\n0.05535714285714286\nLoading mesh from: /home/weihu/lumi/luminescent/studies/PVGC/geometry/3____Si____wg____unnamed31.obj\n0.05535714285714286\nLoading mesh from: /home/weihu/lumi/luminescent/studies/PVGC/geometry/1____design____design____unnamed11.obj\n0.05535714285714286\nLoading mesh from: /home/weihu/lumi/luminescent/studies/PVGC/geometry/2____Si____wg____unnamed21.obj\n"},"children":[],"key":"cvtrKu2NCQ"},{"type":"output","jupyter_data":{"ename":"SystemExit","evalue":"","output_type":"error","traceback":"An exception has occurred, use %tb to see the full traceback.\n\n\u001b[31mSystemExit\u001b[39m\n"},"children":[],"key":"WIOCCiNn1V"},{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"/home/weihu/.local/lib/python3.12/site-packages/IPython/core/interactiveshell.py:3709: UserWarning: To exit: use 'exit', 'quit', or Ctrl-D.\n  warn(\"To exit: use 'exit', 'quit', or Ctrl-D.\", stacklevel=1)\n"},"children":[],"key":"ZFr76f1iDG"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"ac6aeef162231506a0da779db2d5767e","path":"/build/ac6aeef162231506a0da779db2d5767e.png"},"text/plain":{"content":"<Figure size 640x480 with 6 Axes>","content_type":"text/plain"}}},"children":[],"key":"XD4opGma9a"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"625abd8acbef9c1e97cde35acd6c651e","path":"/build/625abd8acbef9c1e97cde35acd6c651e.png"},"text/plain":{"content":"<Figure size 640x480 with 6 Axes>","content_type":"text/plain"}}},"children":[],"key":"J0LeTTikDF"}],"key":"ERE9b7boyb"}],"key":"VbkrweOu7D"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"nres=6\nsaveat=1\nwavelengths=np.linspace(1.5,1.6,101)\ntmax=40\npath0=path\npath=path0+'_final'\nos.system(f'cp -r {path0}/designs/ {path}')\nlumi.make(\n    #\n    path=path,  # path to make problem folder\n    component=c,\n    wavelength=wavelength,\n    wavelengths=wavelengths,\n    ports=ports,\n    modes=modes,\n    sources=sources,\n    boundaries=boundaries,\n    #\n    material_library=material_library,\n    layer_stack=layer_stack,\n    #\n    zmin=zmin,  # zmin of simulation region\n    zmax=zmax,  # zmax of simulation region\n    #\n    nres=nres,\n    tmax=tmax,  # total simulation time in periods\n    relative_pml_depths=relative_pml_depths,\n    relative_courant=relative_courant,\n    saveat=saveat,\n    #\n    views=views,\n    # inverse design parameters\n    load_saved_designs=True,\n    designs=designs,\n)\nraise SystemExit","key":"aCndh3au8E"},{"type":"outputs","id":"ERJzcl_PKbbGOT4SBjFX-","children":[],"key":"i1TG9Dt2QW"}],"key":"hhzdU4cUi7"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"lumi.movie(path,views,1)#,run=False)","key":"VMrfTfFTyz"},{"type":"outputs","id":"q6Wc4cTEjV2jos58VQhUp","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Video generated successfully at /home/weihu/lumi/luminescent/studies/PVGC/simulation.gif!\n"},"children":[],"key":"S5wpHcwnxX"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/gif":{"content_type":"image/gif","hash":"b1ef74f3151841d1ceb1d07f1ed3d478","path":"/build/b1ef74f3151841d1ceb1d07f1ed3d478.gif"},"text/plain":{"content":"<IPython.core.display.Image object>","content_type":"text/plain"}}},"children":[],"key":"qaTihrZiJV"}],"key":"HwylE3In9x"}],"key":"IL169F4bBz"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"plt.close()\nsol = lumi.load(path)\nx = wavelengths\n\ny = lumi.query(sol, \"To2@0,o1@0\")  # wavelength or frequency ordered depending on problem setup\ny=[10*np.log10(y) for y in y]\n\nplt.plot(x, y)\nplt.xlabel(\"wavelength [um]\")\nplt.ylabel(\"S21 [dB]\")\nplt.show()","key":"B6t4p0ugDw"},{"type":"outputs","id":"bQZhRTKAST7hMg1HDTlvm","children":[],"key":"TgcvfKTeWq"}],"key":"QQ7eD1otQH"}],"key":"DqD9Iniedm"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Inverse design of photonic wavelength division demultiplexer","url":"/opt-demux","group":"Inverse design tutorials"},"next":{"title":"Photonic PDK","url":"/pdk","group":"Lumi inverse design PDK (under development)"}}},"domain":"http://localhost:3000"}