{"version":3,"kind":"Notebook","sha256":"1b2c9df15061fbb805699b269048e33d9924211f31b41fcc6ef29d3fd90f6cd0","slug":"opt-demux","location":"/opt_demux.ipynb","dependencies":[],"frontmatter":{"title":"Inverse design of photonic wavelength division demultiplexer","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"base","language":"python"},"numbering":{"title":{"offset":2}},"exports":[{"format":"ipynb","filename":"opt_demux.ipynb","url":"/build/opt_demux-1b6ae45043548279f6470d54d87d7f63.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Overview","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GRRg8rbp8z"}],"identifier":"overview","label":"Overview","html_id":"overview","implicit":true,"key":"xEeLRtuhRi"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"We inverse design a 1x4 wavelength demultiplexer (WDM) in silicon photonics splitting 4 wavelengths spaced 20nm apart into 4 output waveguides. Design region is a 8um x 8um square of silicon surrounded by silica cladding. We use differentiable simulation powered adjoint optimization to aim for high channel transmission while minimizing crosstalk. For sake of speed this is done in 2.5D (differs from 3D by only couple lines in the code).","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"JvOOwWw5KU"}],"key":"E6djwSNMku"}],"key":"G7loCvYVOg"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Geometry","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jHDzRp7u81"}],"identifier":"geometry","label":"Geometry","html_id":"geometry","implicit":true,"key":"c8Cfb2NdEF"}],"key":"iVxBEBYj6s"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\nimport math\nimport numpy as np\nimport luminescent as lumi\nimport gdsfactory as gf\nfrom gdsfactory.technology import LogicalLayer, LayerLevel, LayerStack\nimport matplotlib.pyplot as plt\nfrom IPython.display import Image, display\n\n\n# folder for saving config and results\npath = os.path.join(\"runs\", \"demux\")\n\nwavelength = 1.3  # characteristic wavelength\nwavelengths = 1.27, 1.29, 1.31, 1.33\n\n# layers\nWG = (1, 0)  # waveguide layer\nCLAD = (2, 0)  # cladding layer\nDESIGN = (100, 0)  # design region layer\n\n# makes gdsfactory component to be optimized. has rectangular design region with port stubs. ports numbered clockwise from bottom left\nlength = 6.0\nwidth = 6.0\nw_wg = 0.4\nl_wg = 3 * w_wg\nc = gf.Component()\ndut = lumi.mimo(\n    length,\n    width,\n    west=1,\n    east=4,\n    w_wg=w_wg,\n    l_wg=l_wg,\n    init=1,  # solid slab\n    layer_wg=WG,\n    layer_design=DESIGN,\n)\n# metadata. here we include design region info containing port locations useful for loading the optimized component after optimization\ninfo = {\"designs\": [{\"ports\": dut.info.ports}]}\ndut = c << dut\n\n# margin extensions\nlateral_port_margin = height_port_margin = 0.4\nxmargin = 1.5 * lateral_port_margin\nzmargin = 1.5 * height_port_margin\nsource_port_margin = 1.0 * (w_wg + 2 * lateral_port_margin)\next = c << gf.components.straight(source_port_margin, width=w_wg)\next.connect(\"o2\", dut.ports[\"o1\"])\n\n# add ports\nfor i in range(1, 6):\n    c.add_port(f\"o{i}\", port=dut.ports[f\"o{i}\"])\n\nc << gf.components.bbox(component=c, layer=CLAD, top=xmargin, bottom=xmargin)\nc.plot()","key":"WOAUD7H0vc"},{"type":"outputs","id":"FV4cUPcS69SY2jl7TdJmJ","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"ff90ea0c785c50c5057fd6ac00c567dd","path":"/build/ff90ea0c785c50c5057fd6ac00c567dd.png"},"text/plain":{"content":"<Figure size 800x600 with 1 Axes>","content_type":"text/plain"}}},"children":[],"key":"MF5tyb77vq"}],"key":"JshPd92wQF"}],"key":"HrLWVZDH4z"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Solve","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"pFLKeVLmjZ"}],"identifier":"solve","label":"Solve","html_id":"solve","implicit":true,"key":"ByQo9KWJxn"}],"key":"Hi5VYylqMr"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# layer stack. lower mesh order layers override higher mesh order layers. for 2.5D problems as is here, the mesher will slice thru middle of 'core' layer\nthickness = 0.22\nmaterials_library = lumi.MATERIALS_LIBRARY\nnSi = math.sqrt(materials_library[\"Si\"][\"epsilon\"])\nmaterials_library.update(\n    {\n        \"design\": lumi.PlaceholderMaterial(mesh_density=nSi),  # placeholder material for design region\n        \"background\": materials_library[\"SiO2\"],\n    }\n)\n\nlayer_stack = LayerStack(\n    layers={\n        \"design\": LayerLevel(\n            layer=LogicalLayer(layer=DESIGN),\n            thickness=thickness,\n            zmin=0.0,\n            material=\"design\",\n            mesh_order=0,\n        ),\n        \"core\": LayerLevel(\n            layer=LogicalLayer(layer=WG),\n            thickness=thickness,\n            zmin=0.0,\n            material=\"Si\",\n            mesh_order=1,\n        ),\n    }\n)  \n\n# time [periods at characteristic wavelength ]\nTsim = (source_port_margin + 2 * l_wg + 4 * (length + width)) / wavelength * nSi\n\n# each mode will be solved for sources and monitors\nmodes = [lumi.Mode(wavelength=wavelength)]\nsources = [\n    lumi.Source(\n        \"o1\",\n        source_port_margin=source_port_margin,\n        wavelength=wavelength,\n        bandwidth=0.2,\n    )\n]\ndesigns = [\n    lumi.Design(\n        name=\"d1\",\n        layer=DESIGN,\n        lmin=0.15,\n        fill_material=\"Si\",\n        void_material=\"SiO2\",\n    )\n]\n# optimization targets of Tsim params.\n# o1@0 means optical port 1 on mode 0 (fundamental mode)\ntargets = [\n    lumi.Target(\n        key=f\"To{i+2}@0,o1@0\",\n        target=1.0,\n        weight=1 / 4,\n        wavelength=wl,\n    )\n    for i, wl in enumerate(wavelengths)\n]\n\noptimizer = lumi.Optimizer(stoploss=0.1, iters=50,momentum=.8)\n\nkwargs = dict(\n    path=path,  # path to make problem folder\n    component=c,\n    wavelengths=wavelengths,\n    wavelength=wavelength,\n    modes=modes,\n    info=info,\n    sources=sources,\n    #\n    lateral_port_margin=lateral_port_margin,\n    height_port_margin=height_port_margin,\n    zmin=-zmargin,\n    zmax=thickness + zmargin,\n    #\n    materials_library=materials_library,\n    layer_stack=layer_stack,\n    #\n    gpu=\"CUDA\",\n    nres=6,  # number of grid points per wavelength in material (not vacuum)\n    relative_courant=0.9,\n    Tsim=Tsim,\n    force=True,  # overwrite files in existing path\n    #\n    approx_2D_mode=\"TE\",  # makes problem 2.5D instead of 3D\n    z=thickness / 2,  # z coordinate to slice the 2.5D problem at\n    #\n    designs=designs,\n    targets=targets,\n    optimizer=optimizer,\n)\nlumi.make(**kwargs)\nlumi.solve(path)\ndisplay(Image(filename=os.path.join(path, \"peak.png\")))\nlumi.plot(path)","key":"zQ93s7KFJ2"},{"type":"outputs","id":"uAz86BEHBArbH93Ps-DoG","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"cfebb4f1fe3649ba9029a39b3a158203","path":"/build/cfebb4f1fe3649ba9029a39b3a158203.png"},"text/plain":{"content":"<Figure size 640x480 with 6 Axes>","content_type":"text/plain"}}},"children":[],"key":"elf0Kw0Ks2"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"72f9e6df38b984f5282a57a4a3d96f2b","path":"/build/72f9e6df38b984f5282a57a4a3d96f2b.png"},"text/plain":{"content":"<Figure size 640x480 with 6 Axes>","content_type":"text/plain"}}},"children":[],"key":"XpEMJeTpQx"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"using simulation folder runs\\demux\n"},"children":[],"key":"K43rXXs8vR"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"57ccef7cb3a83dba5f431212a678391d","path":"/build/57ccef7cb3a83dba5f431212a678391d.png"},"text/plain":{"content":"<IPython.core.display.Image object>","content_type":"text/plain"}}},"children":[],"key":"Gn5EmJTAVj"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Video generated successfully at runs\\demux\\simulation.mp4!\n"},"children":[],"key":"QMTdiZaVon"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":31,"metadata":{},"data":{"text/plain":{"content":"< cv2.VideoWriter 000001EEB391FC30>","content_type":"text/plain"}}},"children":[],"key":"NomXHjHD7D"}],"key":"O6CZprOuJb"}],"key":"tGTb8i5DxL"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Post optimization simulation","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"kzjg7cOI22"}],"identifier":"post-optimization-simulation","label":"Post optimization simulation","html_id":"post-optimization-simulation","implicit":true,"key":"dB7Tr4rknu"}],"key":"Z3bBGCoUQk"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# new simulation with optimized design and finer spaced wavelengths\ndel kwargs['targets']\ndel kwargs['optimizer']\nwavelengths1=np.linspace(1.26, 1.34, 81)\nkwargs.update(\n    wavelengths=wavelengths1,\n    load_saved_designs=True)\nlumi.make(**kwargs)\nlumi.solve(path)","key":"ThGs71nZme"},{"type":"outputs","id":"uwI26juQOMR9rwBy2Kku6","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"cfebb4f1fe3649ba9029a39b3a158203","path":"/build/cfebb4f1fe3649ba9029a39b3a158203.png"},"text/plain":{"content":"<Figure size 640x480 with 6 Axes>","content_type":"text/plain"}}},"children":[],"key":"cxGt6vfesq"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"72f9e6df38b984f5282a57a4a3d96f2b","path":"/build/72f9e6df38b984f5282a57a4a3d96f2b.png"},"text/plain":{"content":"<Figure size 640x480 with 6 Axes>","content_type":"text/plain"}}},"children":[],"key":"Ivs3y4goiy"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"using simulation folder runs\\demux\n"},"children":[],"key":"F4a8wcRKZz"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":26,"metadata":{},"data":{"text/plain":{"content":"0","content_type":"text/plain"}}},"children":[],"key":"hW0uU6KsUS"}],"key":"SYsfbOSnlC"}],"key":"gkMo7qcc97"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"sol = lumi.load(path)\nx = wavelengths1\nys = [lumi.query(sol, f\"To{i}@0,o1@0\") for i in range(2, 6)]\nplt.figure()\nfor y in ys:\n    plt.plot(x, [10*math.log10( y) for y in y])\nplt.scatter(wavelengths, [0]*len(wavelengths), 100, marker=\"*\")\nplt.xlabel(\"wavelength [um]\")\nplt.ylabel(\"transmission [dB]\")\nplt.show()","key":"w0D38XAir1"},{"type":"outputs","id":"sfNG_HaaaW0drwBOH17cu","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"loading solution from c:\\Users\\default.LAPTOP-HMRU58MH\\Desktop\\lumi\\luminescent\\runs\\demux\n"},"children":[],"key":"OrzIJQmkzu"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"aebbedbebda42f737890655f46eab54a","path":"/build/aebbedbebda42f737890655f46eab54a.png"},"text/plain":{"content":"<Figure size 640x480 with 1 Axes>","content_type":"text/plain"}}},"children":[],"key":"cNroKTq6e5"}],"key":"lasypzOKDO"}],"key":"yOwchC7CXP"}],"key":"KMfCcQYZ3p"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"RF microstrip: quarter wave stub filter","url":"/test-stub","group":"Simulation tutorials"},"next":{"title":"Inverse design of perfectly vertical photonic (meta)grating coupler","url":"/opt-pvgc","group":"Inverse design tutorials"}}},"domain":"http://localhost:3002"}